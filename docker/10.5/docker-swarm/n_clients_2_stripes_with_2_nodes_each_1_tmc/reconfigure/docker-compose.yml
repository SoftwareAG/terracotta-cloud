# Copyright (c) 2011-2020 Software AG, Darmstadt, Germany and/or Software AG USA Inc., Reston, VA, USA, and/or its subsidiaries and/or its affiliates and/or their licensors.
# Use, reproduction, transfer, publication or disclosure is prohibited except as specifically provided for in your License Agreement with Software AG.

version: '3.4'

networks:
  terracotta-net:
# following line to uncomment when using a "real" Docker swarm, not Docker Swarm mode
    driver: overlay
#to allow debugging from outside the stack
    attachable: true

volumes:
  dataroots:
  backups:
  configs:
  tmc:

services:
  cluster-tool:
    image: cluster-tool-with-configs:10.5.0-SNAPSHOT
    command: configure -n MyCluster /configs/stripe1.xml /configs/stripe2.xml
    volumes:
      - configs:/configs/
    environment:
      - ACCEPT_EULA=Y
    networks:
     - terracotta-net
    deploy:
      restart_policy:
        condition: on-failure

  caching-client:
    image: sample-ehcache-client:10.5.0-SNAPSHOT
    networks:
      - terracotta-net
    environment:
      - ACCEPT_EULA=Y
      - TERRACOTTA_SERVER_URL=terracotta-1-1:9410,terracotta-1-2:9410,terracotta-2-1:9410,terracotta-2-2:9410
    depends_on:
      - cluster-tool

  store-client:
    image: sample-tcstore-client:10.5.0-SNAPSHOT
    networks:
      - terracotta-net
    environment:
      - ACCEPT_EULA=Y
      - TERRACOTTA_SERVER_URL=terracotta-1-1:9410,terracotta-1-2:9410,terracotta-2-1:9410,terracotta-2-2:9410
    depends_on:
      - cluster-tool

  tmc:
    image: tmc:10.5.0-SNAPSHOT
    environment:
      - ACCEPT_EULA=Y
      - TMS_DEFAULTURL=terracotta://terracotta-1-1:9410,terracotta-1-2:9410,terracotta-2-1:9410,terracotta-2-2:9410
    ports:
      - "9480"
    networks:
      - terracotta-net
    depends_on:
      - cluster-tool
    volumes:
      - tmc:/data/tmc/

  terracotta-1-1:
    hostname: terracotta-1-1
    image: terracotta-server:10.5.0-SNAPSHOT
    volumes:
      - dataroots:/data/dataroots/
      - backups:/data/backups/
      - configs:/configs/
    environment:
      - ACCEPT_EULA=Y
    entrypoint:
      - bin/start-tc-server.sh
      - -f
      - /configs/stripe1.xml
      - -n
      - terracotta-1-1
    networks:
      - terracotta-net

  terracotta-1-2:
    hostname: terracotta-1-2
    image: terracotta-server:10.5.0-SNAPSHOT
    volumes:
      - dataroots:/data/dataroots/
      - backups:/data/backups/
      - configs:/configs/
    environment:
      - ACCEPT_EULA=Y
    entrypoint:
      - bin/start-tc-server.sh
      - -f
      - /configs/stripe1.xml
      - -n
      - terracotta-1-2
    networks:
      - terracotta-net

  terracotta-2-1:
    hostname: terracotta-2-1
    image: terracotta-server:10.5.0-SNAPSHOT
    volumes:
      - dataroots:/data/dataroots/
      - backups:/data/backups/
      - configs:/configs/
    environment:
      - ACCEPT_EULA=Y
    entrypoint:
      - bin/start-tc-server.sh
      - -f
      - /configs/stripe2.xml
      - -n
      - terracotta-2-1
    networks:
      - terracotta-net

  terracotta-2-2:
    hostname: terracotta-2-2
    image: terracotta-server:10.5.0-SNAPSHOT
    volumes:
      - dataroots:/data/dataroots/
      - backups:/data/backups/
      - configs:/configs/
    environment:
      - ACCEPT_EULA=Y
    entrypoint:
      - bin/start-tc-server.sh
      - -f
      - /configs/stripe2.xml
      - -n
      - terracotta-2-2
    networks:
      - terracotta-net